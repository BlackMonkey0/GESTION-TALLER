<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reconocimiento de Matr√≠culas Italianas con IA</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      color: #333;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    h1, h2 { color: #c62828; }
    input, button, img, video, canvas { margin: 10px 0; }
    input[type="file"] {
      padding: 10px; font-size: 16px;
      border: 1px solid #ccc; border-radius: 5px;
    }
    button {
      padding: 10px 20px; background: #e53935;
      color: white; border: none; border-radius: 5px;
      cursor: pointer;
    }
    button:hover { background: #c62828; }
    #resultado {
      margin-top: 20px; padding: 15px;
      background: #fff; border-radius: 5px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      width: 80%;
      max-width: 500px;
      text-align: left;
    }
    .error { color: #c62828; font-weight: bold; }
    .success { color: #28a745; font-weight: bold; }
    #videoContainer {
      width: 100%;
      max-width: 500px;
      margin: 10px auto;
      border: 1px solid #ddd;
      background-color: black;
      position: relative;
    }
    #videoElement {
      width: 100%;
      height: auto;
      display: block;
    }
    #cameraControls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }
    .info-list {
      list-style: none;
      padding: 0;
    }
    .info-list li {
      margin-bottom: 5px;
    }
    .info-list strong {
      display: inline-block;
      min-width: 120px;
    }
  </style>
</head>
<body>
  <h1>üì∏ Lector de Matr√≠culas Italianas (con IA)</h1>

  <h2>üìÇ Subir base de datos personalizada</h2>
  <p>Sube tu archivo CSV o JSON con informaci√≥n de matr√≠culas:</p>
  <input type="file" id="csvInput" accept=".csv">
  <input type="file" id="jsonInput" accept=".json">

  <hr style="width: 80%; margin: 20px 0;">

  <h2>üìÅ Subir una imagen</h2>
  <input type="file" id="uploadImage" accept="image/*">
  <button onclick="enviarImagen('upload')">Reconocer Matr√≠cula (Archivo)</button>

  <hr style="width: 80%; margin: 20px 0;">

  <h2>üé• Usar C√°mara</h2>
  <button onclick="iniciarCamara()">Iniciar C√°mara</button>
  <div id="videoContainer">
    <video id="videoElement" autoplay></video>
  </div>
  <div id="cameraControls">
    <button onclick="tomarFoto()" id="takeFotoBtn" style="display: none;">Tomar Foto</button>
    <button onclick="detenerCamara()" id="stopCameraBtn" style="display: none;">Detener C√°mara</button>
  </div>
  <canvas id="canvasElement" style="display: none;"></canvas>

  <div id="resultado"></div>

  <script>
    const API_TOKEN = "123dd249332b4bdc8f555bbdf036d316ad9083d1"; // Reemplaza con tu token real

    const video = document.getElementById('videoElement');
    const canvas = document.getElementById('canvasElement');
    const takeFotoBtn = document.getElementById('takeFotoBtn');
    const stopCameraBtn = document.getElementById('stopCameraBtn');
    const resultadoDiv = document.getElementById('resultado');
    let stream;
    let datosVehiculos = [];

    document.getElementById("csvInput").addEventListener("change", async function () {
      const file = this.files[0];
      if (!file) return;

      const text = await file.text();
      const rows = text.split('\n').map(row => row.trim()).filter(Boolean);
      const headers = rows[0].split(',').map(h => h.trim());
      datosVehiculos = rows.slice(1).map(row => {
        const values = row.split(',').map(v => v.trim());
        const obj = {};
        headers.forEach((header, index) => {
          obj[header] = values[index] || '';
        });
        return obj;
      });

      console.log("CSV cargado:", datosVehiculos);
      resultadoDiv.innerHTML = "<p class='success'>‚úÖ Archivo CSV cargado correctamente.</p>";
    });

    document.getElementById("jsonInput").addEventListener("change", async function () {
      const file = this.files[0];
      if (!file) return;

      try {
        const text = await file.text();
        datosVehiculos = JSON.parse(text);
        console.log("JSON cargado:", datosVehiculos);
        resultadoDiv.innerHTML = "<p class='success'>‚úÖ Archivo JSON cargado correctamente.</p>";
      } catch (error) {
        console.error("Error al leer JSON:", error);
        resultadoDiv.innerHTML = "<p class='error'>‚ùå Error al procesar el archivo JSON.</p>";
      }
    });

    async function iniciarCamara() {
      resultadoDiv.innerHTML = '<p>Iniciando c√°mara...</p>';
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: "environment" } } });
        video.srcObject = stream;
        video.style.display = 'block';
        takeFotoBtn.style.display = 'inline-block';
        stopCameraBtn.style.display = 'inline-block';
        resultadoDiv.innerHTML = '';
      } catch (err) {
        console.error("Error al acceder a la c√°mara: ", err);
        resultadoDiv.innerHTML = '<p class="error">‚ùå No se pudo iniciar la c√°mara. Aseg√∫rate de dar permisos.</p>';
      }
    }

    function tomarFoto() {
      if (!stream) {
        resultadoDiv.innerHTML = '<p class="error">‚ö†Ô∏è La c√°mara no est√° activa.</p>';
        return;
      }
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const context = canvas.getContext('2d');
      context.drawImage(video, 0, 0, canvas.width, canvas.height);

      canvas.toBlob(blob => {
        enviarImagen('camera', blob);
      }, 'image/jpeg', 0.9);
    }

    function detenerCamara() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        video.srcObject = null;
        video.style.display = 'none';
        takeFotoBtn.style.display = 'none';
        stopCameraBtn.style.display = 'none';
        resultadoDiv.innerHTML = '<p>C√°mara detenida.</p>';
      }
    }

    function enviarImagen(source, blob = null) {
      const formData = new FormData();
      const resultado = document.getElementById("resultado");

      if (source === 'upload') {
        const input = document.getElementById("uploadImage");
        if (!input.files.length) {
          resultado.innerHTML = '<p class="error">‚ö†Ô∏è Selecciona una imagen primero.</p>';
          return;
        }
        formData.append("upload", input.files[0]);
      } else if (source === 'camera' && blob) {
        formData.append("upload", blob, "camera_capture.jpeg");
      } else {
        resultado.innerHTML = '<p class="error">‚ö†Ô∏è Error en la fuente de la imagen.</p>';
        return;
      }

      formData.append("country", "it");
      resultado.innerHTML = "<p>‚è≥ Procesando imagen...</p>";

      fetch("https://api.platerecognizer.com/v1/plate-reader/", {
        method: "POST",
        headers: {
          Authorization: `Token ${API_TOKEN}`
        },
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        console.log(data);
        if (data.results && data.results.length > 0) {
          const placaDetectada = data.results[0].plate.toUpperCase();
          resultado.innerHTML = `<h2>‚úÖ Matr√≠cula detectada:</h2><p style='font-size:20px'><strong>${placaDetectada}</strong></p>`;
          buscarInformacionVehiculo(placaDetectada);
        } else {
          resultado.innerHTML = '<p class="error">‚ùå No se detect√≥ ninguna matr√≠cula en la imagen.</p>';
        }
      })
      .catch(err => {
        console.error(err);
        resultado.innerHTML = '<p class="error">‚ö†Ô∏è Error al procesar la imagen.</p>';
      });
    }

    function buscarInformacionVehiculo(placa) {
      const infoVehiculo = datosVehiculos.find(vehiculo =>
        vehiculo.Matricula && vehiculo.Matricula.toUpperCase() === placa
      );

      if (infoVehiculo) {
        let htmlInfo = `<h3 class="success">Informaci√≥n del Veh√≠culo:</h3><ul class="info-list">`;
        for (const key in infoVehiculo) {
          if (infoVehiculo.hasOwnProperty(key)) {
            htmlInfo += `<li><strong>${key.replace(/([A-Z])/g, ' $1').trim()}:</strong> ${infoVehiculo[key]}</li>`;
          }
        }
        htmlInfo += `</ul>`;
        resultadoDiv.innerHTML += htmlInfo;
      } else {
        resultadoDiv.innerHTML += '<p class="error">üö´ No se encontr√≥ informaci√≥n para esta matr√≠cula en la base de datos.</p>';
      }
    }

    window.addEventListener('beforeunload', detenerCamara);
  </script>
</body>
</html>
