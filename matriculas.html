<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Reconocimiento de Matr√≠culas Italianas con IA</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      color: #333;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    h1, h2 { color: #c62828; }
    input, button, img, video, canvas { margin: 10px 0; }
    input[type="file"] {
      padding: 10px; font-size: 16px;
      border: 1px solid #ccc; border-radius: 5px;
    }
    button {
      padding: 10px 20px; background: #e53935;
      color: white; border: none; border-radius: 5px;
      cursor: pointer;
    }
    button:hover { background: #c62828; }
    #resultado {
      margin-top: 20px; padding: 15px;
      background: #fff; border-radius: 5px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      width: 80%;
      max-width: 500px;
    }
    .error { color: #c62828; font-weight: bold; }

    /* Estilos para la c√°mara */
    #videoContainer {
      width: 100%;
      max-width: 500px;
      margin: 10px auto;
      border: 1px solid #ddd;
      background-color: black;
      position: relative;
    }
    #videoElement {
      width: 100%;
      height: auto;
      display: block; /* Para eliminar el espacio extra debajo del video */
    }
    #canvasElement {
      display: none; /* Ocultar el canvas inicialmente */
    }
    #cameraControls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>üì∏ Lector de Matr√≠culas Italianas (con IA)</h1>
  <p>Sube una foto o usa la c√°mara para analizar una matr√≠cula italiana:</p>

  <input type="file" id="uploadImage" accept="image/*">
  <button onclick="enviarImagen('upload')">Reconocer Matr√≠cula (Archivo)</button>

  <hr style="width: 80%; margin: 20px 0;">

  <h2>üé• Usar C√°mara</h2>
  <button onclick="iniciarCamara()">Iniciar C√°mara</button>
  <div id="videoContainer">
    <video id="videoElement" autoplay></video>
  </div>
  <div id="cameraControls">
    <button onclick="tomarFoto()" id="takeFotoBtn" style="display: none;">Tomar Foto</button>
    <button onclick="detenerCamara()" id="stopCameraBtn" style="display: none;">Detener C√°mara</button>
  </div>
  <canvas id="canvasElement" style="display: none;"></canvas> <div id="resultado"></div>

  <script>
    // **IMPORTANTE**: Reemplaza esto con tu propio token de Plate Recognizer.
    // Este token es un ejemplo y no funcionar√°.
    const API_TOKEN = "123dd249332b4bdc8f555bbdf036d316ad9083d1";

    const video = document.getElementById('videoElement');
    const canvas = document.getElementById('canvasElement');
    const takeFotoBtn = document.getElementById('takeFotoBtn');
    const stopCameraBtn = document.getElementById('stopCameraBtn');
    const resultadoDiv = document.getElementById('resultado');
    let stream; // Para almacenar el stream de la c√°mara

    async function iniciarCamara() {
      resultadoDiv.innerHTML = '<p>Iniciando c√°mara...</p>';
      try {
        // Pedir permiso para la c√°mara, preferiendo la trasera (environment)
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: "environment" } } });
        video.srcObject = stream;
        video.style.display = 'block';
        takeFotoBtn.style.display = 'inline-block';
        stopCameraBtn.style.display = 'inline-block';
        resultadoDiv.innerHTML = ''; // Limpiar mensaje de inicio
      } catch (err) {
        console.error("Error al acceder a la c√°mara: ", err);
        resultadoDiv.innerHTML = '<p class="error">‚ùå No se pudo iniciar la c√°mara. Aseg√∫rate de dar permisos.</p>';
      }
    }

    function tomarFoto() {
      if (!stream) {
        resultadoDiv.innerHTML = '<p class="error">‚ö†Ô∏è La c√°mara no est√° activa.</p>';
        return;
      }
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const context = canvas.getContext('2d');
      context.drawImage(video, 0, 0, canvas.width, canvas.height);

      // Convertir la imagen del canvas a un Blob (equivalente a un archivo)
      canvas.toBlob(blob => {
        enviarImagen('camera', blob);
      }, 'image/jpeg'); // Puedes elegir 'image/png' si prefieres
    }

    function detenerCamara() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop()); // Detener todas las pistas (video, audio si hubiera)
        video.srcObject = null;
        video.style.display = 'none';
        takeFotoBtn.style.display = 'none';
        stopCameraBtn.style.display = 'none';
        resultadoDiv.innerHTML = '<p>C√°mara detenida.</p>';
      }
    }


    function enviarImagen(source, blob = null) {
      const formData = new FormData();
      const resultado = document.getElementById("resultado");

      if (source === 'upload') {
        const input = document.getElementById("uploadImage");
        if (!input.files.length) {
          resultado.innerHTML = '<p class="error">‚ö†Ô∏è Selecciona una imagen primero.</p>';
          return;
        }
        formData.append("upload", input.files[0]);
      } else if (source === 'camera' && blob) {
        formData.append("upload", blob, "camera_capture.jpeg"); // El tercer argumento es el nombre del archivo
      } else {
        resultado.innerHTML = '<p class="error">‚ö†Ô∏è Error en la fuente de la imagen.</p>';
        return;
      }

      // A√±adir el pa√≠s para filtrar la detecci√≥n a matr√≠culas italianas
      formData.append("country", "it"); // "it" para Italia

      resultado.innerHTML = "<p>‚è≥ Procesando imagen...</p>";

      fetch("https://api.platerecognizer.com/v1/plate-reader/", {
        method: "POST",
        headers: {
          Authorization: `Token ${API_TOKEN}`
        },
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        console.log(data);
        if (data.results && data.results.length > 0) {
          const placa = data.results[0].plate.toUpperCase();
          resultado.innerHTML = `<h2>‚úÖ Matr√≠cula detectada:</h2><p style='font-size:20px'><strong>${placa}</strong></p>`;
          // Aqu√≠ llamar√≠as a una funci√≥n para buscar en tu "base de datos" de Excel
          // buscarInformacionMatricula(placa);
        } else {
          resultado.innerHTML = '<p class="error">‚ùå No se detect√≥ ninguna matr√≠cula en la imagen.</p>';
        }
      })
      .catch(err => {
        console.error(err);
        resultado.innerHTML = '<p class="error">‚ö†Ô∏è Error al procesar la imagen.</p>';
      });
    }

    // Asegurarse de detener la c√°mara si el usuario navega fuera de la p√°gina
    window.addEventListener('beforeunload', detenerCamara);
  </script>
</body>
</html>
