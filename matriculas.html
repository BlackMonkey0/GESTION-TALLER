<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Buscador de Veh√≠culos por Matr√≠cula Italiana</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      color: #333;
      padding: 20px;
    }
    h1, h2 { color: #c62828; }
    input, button, video, canvas { margin: 10px 0; }
    input[type="text"], input[type="file"] {
      padding: 10px; font-size: 16px;
      border: 1px solid #ccc; border-radius: 5px; width: 250px;
    }
    button {
      padding: 10px 20px; background: #e53935;
      color: white; border: none; border-radius: 5px;
      cursor: pointer;
    }
    button:hover { background: #c62828; }
    #resultado, #galeria {
      margin-top: 20px; padding: 15px;
      background: #fff; border-radius: 5px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    #galeria img {
      max-width: 120px; margin: 5px;
      border-radius: 4px; border: 1px solid #ccc;
    }
    .error { color: #c62828; font-weight: bold; }
    .video-container { display: flex; flex-direction: column; }
  </style>
</head>
<body>
  <h1>Buscador de Veh√≠culos por Matr√≠cula Italiana üáÆüáπ</h1>

  <input type="file" id="fileInput" accept=".xlsx, .xls" />
  <br>
  <input type="text" id="inputMatricula" placeholder="Ej: AB123CD" />
  <button id="searchBtn">Buscar</button>

  <h2>üì∑ Escanear Matr√≠cula con C√°mara</h2>
  <div class="video-container">
    <video id="video" width="320" height="240" autoplay></video>
    <button id="captureBtn">Capturar y Buscar</button>
    <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>
  </div>

  <h2>üñºÔ∏è Subir Imagen de Matr√≠cula</h2>
  <input type="file" id="uploadImage" accept="image/*" />

  <div id="resultado"></div>

  <h2>üóÇÔ∏è Galer√≠a de Fotos (√∫ltimas 4h)</h2>
  <div id="galeria"></div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const inputMatricula = document.getElementById('inputMatricula');
    const searchBtn = document.getElementById('searchBtn');
    const resultado = document.getElementById('resultado');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureBtn = document.getElementById('captureBtn');
    const uploadImage = document.getElementById('uploadImage');
    const galeria = document.getElementById('galeria');
    let vehiculosDB = {};

    // === CARGA DE EXCEL ===
    fileInput.addEventListener('change', event => {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const hoja = workbook.Sheets[workbook.SheetNames[0]];
        const registros = XLSX.utils.sheet_to_json(hoja);

        vehiculosDB = {};
        registros.forEach(row => {
          let matriculaRaw = '';
          for (let key in row) {
            const cleanKey = key.normalize("NFD").replace(/[\u0300-\u036f]/g, '').toUpperCase();
            if (cleanKey.includes("MATRICULA")) {
              matriculaRaw = row[key];
              break;
            }
          }
          const matriculaLimpia = String(matriculaRaw)
            .normalize("NFD").replace(/[\u0300-\u036f]/g, '')
            .toUpperCase().replace(/[^A-Z0-9]/g, '');
          if (matriculaLimpia) vehiculosDB[matriculaLimpia] = row;
        });

        resultado.innerHTML = registros.length
          ? `<p>üìÅ Archivo cargado: ${registros.length} registros.</p>`
          : `<p class="error">‚ùå No se encontraron registros v√°lidos.</p>`;
      };
      reader.readAsArrayBuffer(file);
    });

    // === B√öSQUEDA MANUAL ===
    searchBtn.addEventListener('click', () => buscarMatricula(inputMatricula.value));

    function buscarMatricula(input) {
      const matricula = input.toUpperCase().replace(/[¬∑‚Ä¢\s]/g, '').replace(/[^A-Z0-9]/g, '');
      if (!/^[A-Z]{2}[0-9]{3}[A-Z]{2}$/.test(matricula)) {
        resultado.innerHTML = `<p class="error">‚ö†Ô∏è Formato inv√°lido. Usa AA123BB.</p>`;
        return;
      }

      const data = vehiculosDB[matricula];
      if (data) {
        resultado.innerHTML = `
          <h3>Resultado para: ${matricula.replace(/([A-Z]{2})([0-9]{3})([A-Z]{2})/, '$1 ‚Ä¢ $2 $3')}</h3>
          <ul>${Object.entries(data).map(([k, v]) =>
            `<li><strong>${k}:</strong> ${
              /fecha|itv/i.test(k) ? formatFecha(v) : v
            }</li>`).join('')}</ul>`;
      } else {
        resultado.innerHTML = `<p class="error">‚ùå Matr√≠cula no encontrada: ${matricula}</p>`;
      }
    }

    function formatFecha(fecha) {
      if (typeof fecha === 'number') {
        const parsed = XLSX.SSF.parse_date_code(fecha);
        if (parsed) {
          const { y, m, d } = parsed;
          return `${y}-${String(m).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        }
      }
      const d = new Date(fecha);
      return isNaN(d) ? fecha : d.toISOString().split('T')[0];
    }

    // === C√ÅMARA ===
    navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: "environment" } }
    })
    .then(stream => video.srcObject = stream)
    .catch(() => navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => video.srcObject = stream));

    captureBtn.addEventListener('click', () => {
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      canvas.toBlob(blob => procesarImagen(blob), 'image/jpeg');
    });

    uploadImage.addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) procesarImagen(file);
    });

    // === OCR PROCESAMIENTO ===
    function procesarImagen(blob) {
      const timestamp = Date.now();
      const reader = new FileReader();
      reader.onload = function () {
        const base64 = reader.result;
        guardarImagenEnGaleria(base64, timestamp);
        Tesseract.recognize(base64, 'eng', {
          logger: m => console.log(m)
        }).then(({ data: { text } }) => {
          let limpio = text.toUpperCase()
            .replace(/[‚Ä¢¬∑]/g, '') // s√≠mbolo italiano
            .replace(/[^A-Z0-9]/g, '')
            .replace(/0/g, 'O').replace(/1/g, 'I'); // Correcciones OCR

          const posible = limpio.match(/[A-Z]{2}[0-9]{3}[A-Z]{2}/);
          if (posible && posible[0]) {
            buscarMatricula(posible[0]);
          } else {
            resultado.innerHTML = `<p class="error">‚ùå No se detect√≥ ninguna matr√≠cula v√°lida en la imagen.</p>`;
          }
        });
      };
      reader.readAsDataURL(blob);
    }

    // === GALER√çA ===
    function guardarImagenEnGaleria(base64, timestamp) {
      const imagenes = JSON.parse(localStorage.getItem('galeriaFotos') || '[]');
      imagenes.push({ base64, timestamp });
      localStorage.setItem('galeriaFotos', JSON.stringify(imagenes));
      mostrarGaleria();
    }

    function mostrarGaleria() {
      const imagenes = JSON.parse(localStorage.getItem('galeriaFotos') || '[]');
      const ahora = Date.now();
      const recientes = imagenes.filter(img => ahora - img.timestamp < 4 * 60 * 60 * 1000);
      galeria.innerHTML = recientes.map(img =>
        `<img src="${img.base64}" alt="matr√≠cula">`).join('');
    }

    mostrarGaleria();
  </script>
</body>
</html>
