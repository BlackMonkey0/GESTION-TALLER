<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Buscador de Veh√≠culos por Matr√≠cula</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #ffffff;
      padding: 20px;
      color: #333;
    }
    h1, h2 {
      color: #c62828;
    }
    input, button, video, canvas {
      margin: 10px 0;
    }
    input[type="text"], input[type="file"], input[type="date"] {
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: #f9f9f9;
    }
    button {
      padding: 10px 20px;
      background: #e53935;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #b71c1c;
    }
    #resultado, #galeria {
      margin-top: 20px;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 6px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    #galeria img {
      max-width: 120px;
      margin: 5px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .error {
      color: red;
      font-weight: bold;
    }
    .video-container {
      display: flex;
      flex-direction: column;
    }
  </style>
</head>
<body>
  <h1>Buscador de Veh√≠culos por Matr√≠cula</h1>

  <input type="file" id="fileInput" accept=".xlsx, .xls" />
  <br>
  <input type="text" id="inputMatricula" placeholder="Ej: GX474WG" />
  <button id="searchBtn">Buscar</button>

  <h2>üì∑ Escanear Matr√≠cula con C√°mara</h2>
  <div class="video-container">
    <video id="video" width="320" height="240" autoplay playsinline></video>
    <button id="captureBtn">Capturar y Buscar</button>
    <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>
  </div>

  <h2>üñºÔ∏è Subir Imagen de Matr√≠cula</h2>
  <input type="file" id="uploadImage" accept="image/*" />

  <div id="resultado"></div>

  <h2>üóÇÔ∏è Galer√≠a de Fotos (√∫ltimas 4h)</h2>
  <div id="galeria"></div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const inputMatricula = document.getElementById('inputMatricula');
    const searchBtn = document.getElementById('searchBtn');
    const resultado = document.getElementById('resultado');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureBtn = document.getElementById('captureBtn');
    const uploadImage = document.getElementById('uploadImage');
    const galeria = document.getElementById('galeria');

    let vehiculosDB = {};

    fileInput.addEventListener('change', event => {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = e => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const hoja = workbook.Sheets[workbook.SheetNames[0]];
        const registros = XLSX.utils.sheet_to_json(hoja);

        vehiculosDB = {};
        registros.forEach(row => {
          const posiblesNombres = ['MATRICULA', 'Matricula', 'matricula', 'MATR√çCULA', 'Matr√≠cula', 'matr√≠cula'];
          let matriculaRaw = '';
          for (let nombre of posiblesNombres) {
            if (row[nombre]) {
              matriculaRaw = row[nombre];
              break;
            }
          }
          const matricula = String(matriculaRaw).toUpperCase().replace(/[\s\-]/g, '');
          if (matricula) vehiculosDB[matricula] = row;
        });

        resultado.innerHTML = registros.length
          ? `<p>üìÅ Archivo cargado correctamente (${registros.length} registros).</p>`
          : `<p class="error">No se encontraron registros v√°lidos.</p>`;
      };
      reader.readAsArrayBuffer(file);
    });

    searchBtn.addEventListener('click', () => {
      buscarMatricula(inputMatricula.value);
    });

    function buscarMatricula(rawInput) {
      const matricula = rawInput.trim().toUpperCase().replace(/[\s\-]/g, '');
      if (!matricula) {
        resultado.innerHTML = `<p class="error">Introduce una matr√≠cula v√°lida.</p>`;
        return;
      }

      const datos = vehiculosDB[matricula];
      if (datos) {
        resultado.innerHTML = `
          <h3>Resultado para: ${matricula}</h3>
          <ul>${Object.entries(datos).map(([k, v]) =>
            `<li><strong>${k}:</strong> ${formatearCampo(k, v)}</li>`).join('')}</ul>`;
      } else {
        resultado.innerHTML = `<p class="error">No se encontraron datos para: ${matricula}</p>`;
      }
    }

    function formatearCampo(clave, valor) {
      const claveNormal = clave.toLowerCase();
      if (claveNormal.includes("fecha") || claveNormal.includes("itv")) {
        const fecha = new Date(valor);
        return !isNaN(fecha) ? fecha.toLocaleDateString() : valor;
      }
      return valor;
    }

    // Activar c√°mara trasera
    navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: { ideal: "environment" }
      }
    }).then(stream => video.srcObject = stream)
      .catch(err => console.error("Error al acceder a la c√°mara:", err));

    captureBtn.addEventListener('click', () => {
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      canvas.toBlob(blob => procesarImagen(blob), 'image/jpeg');
    });

    uploadImage.addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) procesarImagen(file);
    });

    function procesarImagen(blob) {
      const timestamp = Date.now();
      const reader = new FileReader();
      reader.onload = function () {
        const base64 = reader.result;
        guardarImagenEnGaleria(base64, timestamp);
        Tesseract.recognize(base64, 'eng', {
          logger: m => console.log(m)
        }).then(({ data: { text } }) => {
          const limpio = text.toUpperCase().replace(/[^A-Z0-9]/g, '');
          const posibleMatricula = limpio.match(/[A-Z]{1,3}\d{1,4}[A-Z]{1,3}/);
          if (posibleMatricula) {
            buscarMatricula(posibleMatricula[0]);
          } else {
            resultado.innerHTML = `<p class="error">No se detect√≥ ninguna matr√≠cula v√°lida en la imagen.</p>`;
          }
        });
      };
      reader.readAsDataURL(blob);
    }

    function guardarImagenEnGaleria(base64, timestamp) {
      const imagenes = JSON.parse(localStorage.getItem('galeriaFotos') || '[]');
      imagenes.push({ base64, timestamp });
      localStorage.setItem('galeriaFotos', JSON.stringify(imagenes));
      mostrarGaleria();
    }

    function mostrarGaleria() {
      const imagenes = JSON.parse(localStorage.getItem('galeriaFotos') || '[]');
      const ahora = Date.now();
      const filtradas = imagenes.filter(img => ahora - img.timestamp < 4 * 60 * 60 * 1000);
      localStorage.setItem('galeriaFotos', JSON.stringify(filtradas));
      galeria.innerHTML = filtradas.map(img =>
        `<img src="${img.base64}" alt="matr√≠cula">`).join('');
    }

    mostrarGaleria();
  </script>
</body>
</html>
