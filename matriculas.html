<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Buscador de Veh√≠culos por Matr√≠cula</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      color: #333;
      padding: 20px;
    }

    h1, h2 {
      color: #d32f2f;
    }

    input, button, video, canvas, select {
      margin: 10px 0;
    }

    input[type="text"], input[type="file"], input[type="date"] {
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    button {
      padding: 10px 20px;
      background: #e57373;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      background: #d32f2f;
    }

    #resultado, #galeria {
      margin-top: 20px;
      padding: 15px;
      background: #fff;
      border-radius: 5px;
      box-shadow: 0 0 6px rgba(0,0,0,0.1);
    }

    #galeria img {
      max-width: 120px;
      margin: 5px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    .error {
      color: #d32f2f;
      font-weight: bold;
    }

    .video-container {
      display: flex;
      flex-direction: column;
    }
  </style>
</head>
<body>
  <h1>Buscador de Veh√≠culos por Matr√≠cula</h1>

  <input type="file" id="fileInput" accept=".xlsx, .xls" />
  <br>
  <input type="text" id="inputMatricula" placeholder="Ej: GZ633DX" />
  <button id="searchBtn">Buscar</button>

  <h2>üì∑ Escanear Matr√≠cula con C√°mara</h2>
  <div class="video-container">
    <video id="video" width="320" height="240" autoplay></video>
    <button id="captureBtn">Capturar y Buscar</button>
    <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>
  </div>

  <h2>üñºÔ∏è Subir Imagen de Matr√≠cula</h2>
  <input type="file" id="uploadImage" accept="image/*" />

  <div id="resultado"></div>

  <h2>üóÇÔ∏è Galer√≠a de Fotos (√∫ltimas 4h)</h2>
  <div id="galeria"></div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const inputMatricula = document.getElementById('inputMatricula');
    const searchBtn = document.getElementById('searchBtn');
    const resultado = document.getElementById('resultado');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureBtn = document.getElementById('captureBtn');
    const uploadImage = document.getElementById('uploadImage');
    const galeria = document.getElementById('galeria');

    let vehiculosDB = {};

    // === CARGA DE EXCEL CON LIMPIEZA DE CLAVES ===
    fileInput.addEventListener('change', event => {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = e => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const hoja = workbook.Sheets[workbook.SheetNames[0]];
        const registros = XLSX.utils.sheet_to_json(hoja);

        vehiculosDB = {};
        registros.forEach(row => {
          let matriculaRaw = '';
          for (let key in row) {
            const normalizedKey = key.normalize("NFD").replace(/[\u0300-\u036f]/g, '').toUpperCase();
            if (normalizedKey.includes("MATRICULA")) {
              matriculaRaw = row[key];
              break;
            }
          }

          const matricula = String(matriculaRaw)
            .normalize("NFD").replace(/[\u0300-\u036f]/g, '')
            .toUpperCase().replace(/[^A-Z0-9]/g, '');

          if (matricula) vehiculosDB[matricula] = row;
        });

        resultado.innerHTML = registros.length
          ? `<p>üìÅ Archivo cargado correctamente (${registros.length} registros).</p>`
          : `<p class="error">No se encontraron registros v√°lidos.</p>`;
      };
      reader.readAsArrayBuffer(file);
    });

    // === B√öSQUEDA MANUAL ===
    searchBtn.addEventListener('click', () => {
      buscarMatricula(inputMatricula.value);
    });

    function buscarMatricula(rawInput) {
      const matricula = rawInput.trim()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, '')
        .toUpperCase().replace(/[^A-Z0-9]/g, '');

      if (!matricula) {
        resultado.innerHTML = `<p class="error">Introduce una matr√≠cula v√°lida.</p>`;
        return;
      }

      const datos = vehiculosDB[matricula];
      if (datos) {
        resultado.innerHTML = `
          <h3>Resultado para: ${matricula}</h3>
          <ul>${Object.entries(datos).map(([k, v]) =>
            `<li><strong>${k}:</strong> ${
              /fecha/i.test(k) || /ITV/i.test(k)
                ? formatFecha(v)
                : v
            }</li>`).join('')}</ul>`;
      } else {
        resultado.innerHTML = `<p class="error">No se encontraron datos para: ${matricula}</p>`;
      }
    }

    function formatFecha(fecha) {
      try {
        const d = new Date(fecha);
        if (!isNaN(d)) {
          return d.toISOString().split('T')[0];
        }
      } catch {}
      return fecha;
    }

    // === C√ÅMARA ===
    navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: { exact: "environment" }
      }
    })
    .then(stream => video.srcObject = stream)
    .catch(err => {
      console.warn("Fallo en c√°mara trasera, usando por defecto:", err);
      return navigator.mediaDevices.getUserMedia({ video: true });
    })
    .then(stream => {
      if (stream) video.srcObject = stream;
    });

    // === CAPTURAR FOTO ===
    captureBtn.addEventListener('click', () => {
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      canvas.toBlob(blob => procesarImagen(blob), 'image/jpeg');
    });

    // === SUBIR IMAGEN ===
    uploadImage.addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) procesarImagen(file);
    });

    // === PROCESAMIENTO OCR CON LIMPIEZA ===
    function procesarImagen(blob) {
      const timestamp = Date.now();
      const reader = new FileReader();
      reader.onload = function () {
        const base64 = reader.result;
        guardarImagenEnGaleria(base64, timestamp);
        Tesseract.recognize(base64, 'eng', {
          logger: m => console.log(m)
        }).then(({ data: { text } }) => {
          const limpio = text.toUpperCase().replace(/[^A-Z0-9]/g, '');
          const posibleMatricula = limpio.match(/[A-Z]{2,3}[0-9]{2,4}[A-Z]{1,3}/);
          if (posibleMatricula) {
            buscarMatricula(posibleMatricula[0]);
          } else {
            resultado.innerHTML = `<p class="error">No se detect√≥ ninguna matr√≠cula v√°lida en la imagen.</p>`;
          }
        });
      };
      reader.readAsDataURL(blob);
    }

    // === GALER√çA DE FOTOS ===
    function guardarImagenEnGaleria(base64, timestamp) {
      const imagenes = JSON.parse(localStorage.getItem('galeriaFotos') || '[]');
      imagenes.push({ base64, timestamp });
      localStorage.setItem('galeriaFotos', JSON.stringify(imagenes));
      mostrarGaleria();
    }

    function mostrarGaleria() {
      const imagenes = JSON.parse(localStorage.getItem('galeriaFotos') || '[]');
      const ahora = Date.now();
      const filtradas = imagenes.filter(img => ahora - img.timestamp < 4 * 60 * 60 * 1000);
      localStorage.setItem('galeriaFotos', JSON.stringify(filtradas));
      galeria.innerHTML = filtradas.map(img =>
        `<img src="${img.base64}" alt="matr√≠cula">`).join('');
    }

    mostrarGaleria();
  </script>
</body>
</html>
